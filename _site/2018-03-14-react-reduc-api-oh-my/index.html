
<figure class="highlight"><pre><code class="language-py" data-lang="py"><span class="n">React</span><span class="p">,</span> <span class="n">Redux</span> <span class="ow">and</span> <span class="n">API</span> <span class="n">OH</span> <span class="n">MY</span><span class="err">!</span>

<span class="c"># React, Redux, API</span>

<span class="k">class</span> <span class="nc">UserDetailsSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ReadOnlyField</span><span class="p">()</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">ProfileSerializer</span><span class="p">(</span><span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">User</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">'id'</span><span class="p">,</span> <span class="s">'url'</span><span class="p">,</span> <span class="s">'username'</span><span class="p">,</span> <span class="s">'first_name'</span><span class="p">,</span> <span class="s">'last_name'</span><span class="p">,</span> <span class="s">'profile'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">TenantSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">HyperlinkedModelSerializer</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ReadOnlyField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Tenant</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">'id'</span><span class="p">,</span> <span class="s">'name'</span><span class="p">,</span> <span class="s">'credits'</span><span class="p">,</span> <span class="s">'credit_override'</span><span class="p">,</span> <span class="s">'max_concurrent'</span><span class="p">,</span> <span class="s">'app_scientist'</span><span class="p">,</span> <span class="s">'job_limit'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ProfileSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">HyperlinkedModelSerializer</span><span class="p">):</span>
    <span class="n">tenant</span> <span class="o">=</span> <span class="n">TenantSerializer</span><span class="p">(</span><span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Profile</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">'tenant'</span><span class="p">,</span> <span class="s">'position'</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">UserViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">IsAuthenticated</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">profile__tenant</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">tenant</span><span class="p">)</span>

    <span class="nd">@list_route</span><span class="p">(</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'get'</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserDetailsSerializer</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">'permissions'</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_perms</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_perms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">perms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">backend</span> <span class="ow">in</span> <span class="n">auth</span><span class="o">.</span><span class="n">get_backends</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="s">"get_all_permissions"</span><span class="p">):</span>
                <span class="n">perms</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">get_all_permissions</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
        <span class="n">perms</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">perms</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">perms</span>

<span class="c">#action </span>
<span class="n">export</span> <span class="n">function</span> <span class="n">fetchCurrentUser</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">const</span> <span class="n">url</span> <span class="o">=</span> <span class="s">'api/users/current_user/'</span><span class="p">;</span>
  <span class="n">const</span> <span class="n">request</span> <span class="o">=</span> <span class="n">axios</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">FETCH_CURRENT_USER</span><span class="p">,</span>
    <span class="n">payload</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="c">#reducer </span>
<span class="n">export</span> <span class="n">default</span> <span class="n">function</span> <span class="p">(</span><span class="n">state</span> <span class="o">=</span> <span class="n">null</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">switch</span> <span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="nb">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">case</span> <span class="n">FETCH_CURRENT_USER</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">action</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">data</span><span class="p">;</span>
    <span class="n">default</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">state</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c">#container</span>
<span class="k">class</span> <span class="nc">App</span> <span class="n">extends</span> <span class="n">Component</span> <span class="p">{</span>
  <span class="n">constructor</span><span class="p">(</span><span class="n">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">props</span><span class="p">);</span>
    <span class="n">this</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">{</span> <span class="n">currUser</span><span class="p">:</span> <span class="n">null</span> <span class="p">};</span>
    <span class="n">this</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">fetchCurrentUser</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="err">!</span><span class="n">this</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">currUser</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="o">&lt;</span><span class="n">Loading</span> <span class="o">/&gt;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="n">div</span><span class="o">&gt;...</span><span class="p">)};</span>

<span class="n">function</span> <span class="n">mapStateToProps</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span> <span class="n">currUser</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">currUser</span> <span class="p">};</span>
<span class="p">}</span>

<span class="n">function</span> <span class="n">mapDispatchToProps</span><span class="p">(</span><span class="n">dispatch</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">bindActionCreators</span><span class="p">({</span> <span class="n">fetchCurrentUser</span> <span class="p">},</span> <span class="n">dispatch</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">export</span> <span class="n">default</span> <span class="n">connect</span><span class="p">(</span><span class="n">mapStateToProps</span><span class="p">,</span> <span class="n">mapDispatchToProps</span><span class="p">)(</span><span class="n">App</span><span class="p">);</span>

<span class="n">App</span><span class="o">.</span><span class="n">propTypes</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">currUser</span><span class="p">:</span> <span class="n">PropTypes</span><span class="o">.</span><span class="n">shape</span><span class="p">({</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">PropTypes</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
    <span class="n">username</span><span class="p">:</span> <span class="n">PropTypes</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
    <span class="n">first_name</span><span class="p">:</span> <span class="n">PropTypes</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
    <span class="n">last_name</span><span class="p">:</span> <span class="n">PropTypes</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
  <span class="p">}),</span>
  <span class="n">currentUser</span><span class="p">:</span> <span class="n">PropTypes</span><span class="o">.</span><span class="n">func</span><span class="p">,</span>
<span class="p">};</span></code></pre></figure>

